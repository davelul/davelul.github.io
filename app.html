<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#111412" />
  <title>INTELLIGENCE CENTER</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <style>
    /*
     * SCALING STRATEGY
     * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     * html font-size = clamp(14px, 1vw, 22px)
     * Everything uses rem so it scales linearly from 1080p ‚Üí 4K.
     * Hard-coded px values only for 1px borders and leaf-let overrides.
     */
    html {
      /* Scales from ~13px on 1080p up to ~28px on 4K */
      font-size: clamp(13px, 1.4vw, 28px);
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:#0a0c0a; --surface:#111412; --panel:#161a16;
      --border:#252b25; --border2:#2e362e;
      --text:#c8d4c8; --muted:#5a6b5a;
      --accent:#b8a547; --accent2:#4a7c59; --danger:#8b3a3a;
      --active-col:#4a7c59; --complete-col:#6aaa8a;
      --mono:'Share Tech Mono',monospace;
      --sans:'Barlow Condensed',sans-serif;
      --radius:0.2rem;
      --nav-h:3rem;
      --bot-nav-h:3.5rem;
      --sidebar-w:18rem;
      --safe-b:env(safe-area-inset-bottom,0px);
    }
    body {
      height: 100dvh; overflow: hidden;
      background: var(--bg); color: var(--text);
      font-family: var(--sans); font-size: 0.9rem;
      -webkit-tap-highlight-color: transparent;
    }
    button,input,select,textarea,a { touch-action: manipulation; }
    ::-webkit-scrollbar { width: 3px; }
    ::-webkit-scrollbar-track { background: var(--surface); }
    ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

    /* ‚îÄ‚îÄ TOP NAV ‚îÄ‚îÄ */
    #nav {
      position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
      height: var(--nav-h);
      background: var(--surface); border-bottom: 1px solid var(--border);
      display: flex; align-items: center;
      padding-top: env(safe-area-inset-top, 0px);
      overflow: hidden;
    }
    #nav-logo {
      padding: 0 1rem;
      font-family: var(--mono); font-size: 0.75rem; letter-spacing: 0.25rem;
      color: var(--accent); border-right: 1px solid var(--border);
      height: 100%; display: flex; align-items: center;
      white-space: nowrap; user-select: none; flex-shrink: 0;
    }
    #nav-logo span { color: var(--muted); font-size: 0.6rem; margin-left: 0.3rem; letter-spacing: 0.15rem; }
    .nav-tabs { display: flex; height: 100%; }
    .nav-tab {
      padding: 0 0.9rem; display: flex; align-items: center; gap: 0.4rem;
      font-family: var(--sans); font-weight: 600; font-size: 0.75rem;
      letter-spacing: 0.1rem; text-transform: uppercase;
      color: var(--muted); cursor: pointer;
      border-right: 1px solid var(--border);
      transition: color .15s, background .15s;
      white-space: nowrap; user-select: none;
    }
    .nav-tab:hover { color: var(--text); background: var(--panel); }
    .nav-tab.active { color: var(--accent); background: var(--panel); }
    .nav-tab .dot {
      width: 0.3rem; height: 0.3rem; border-radius: 50%;
      background: var(--muted); transition: background .15s; flex-shrink: 0;
    }
    .nav-tab.active .dot { background: var(--accent); }
    #nav-right { margin-left: auto; display: flex; align-items: center; height: 100%; }
    .nav-status {
      padding: 0 0.7rem; font-family: var(--mono); font-size: 0.6rem;
      letter-spacing: 0.05rem; color: var(--muted);
      border-left: 1px solid var(--border);
      height: 100%; display: flex; align-items: center; gap: 0.4rem;
      white-space: nowrap;
    }
    .status-dot {
      width: 0.3rem; height: 0.3rem; border-radius: 50%;
      background: var(--accent2); animation: pulse 2s infinite; flex-shrink: 0;
    }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }
    #mobile-menu-btn {
      display: none; width: 2.8rem; height: var(--nav-h);
      margin-left: auto; align-items: center; justify-content: center;
      background: none; border: none; cursor: pointer; color: var(--muted); flex-shrink: 0;
    }
    #mobile-menu-btn svg { width: 1.25rem; height: 1.25rem; stroke: currentColor; fill: none; stroke-width: 1.8; stroke-linecap: round; }

    /* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
    #bot-nav {
      display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000;
      height: calc(var(--bot-nav-h) + var(--safe-b));
      background: var(--surface); border-top: 1px solid var(--border);
      padding-bottom: var(--safe-b);
    }
    #bot-nav-inner { display: flex; height: var(--bot-nav-h); }
    .bot-tab {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 0.2rem;
      cursor: pointer; color: var(--muted); transition: color .15s;
      border: none; background: none;
      font-family: var(--sans); font-size: 0.55rem;
      font-weight: 600; letter-spacing: 0.06rem; text-transform: uppercase;
    }
    .bot-tab.active { color: var(--accent); }
    .bot-tab svg { width: 1.25rem; height: 1.25rem; stroke: currentColor; fill: none; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; }

    /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
    #app { position: fixed; top: var(--nav-h); left: 0; right: 0; bottom: 0; display: flex; }
    #sidebar-overlay {
      display: none; position: fixed; inset: 0; z-index: 900;
      background: rgba(0,0,0,.6); backdrop-filter: blur(2px);
    }
    #sidebar-overlay.open { display: block; }
    #sidebar {
      width: var(--sidebar-w); background: var(--surface);
      border-left: 1px solid var(--border);
      display: flex; flex-direction: column;
      overflow-y: auto; -webkit-overflow-scrolling: touch;
      flex-shrink: 0; transition: width .2s ease; z-index: 200; order: 2;
    }
    #sidebar.collapsed { width: 0; overflow: hidden; }
    .sidebar-section { border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .sidebar-section-header {
      padding: 0.6rem 0.85rem;
      font-family: var(--mono); font-size: 0.6rem; letter-spacing: 0.13rem;
      color: var(--muted); text-transform: uppercase;
      cursor: pointer; display: flex; justify-content: space-between; align-items: center;
      user-select: none; min-height: 2.5rem;
    }
    .sidebar-section-header:hover { color: var(--text); }

    /* Map buttons */
    .map-btn {
      width: 100%; padding: 0.55rem 0.85rem;
      display: flex; align-items: center; gap: 0.6rem;
      background: none; border: none; cursor: pointer; color: var(--muted);
      font-family: var(--sans); font-weight: 600; font-size: 0.85rem;
      text-align: left; transition: color .12s, background .12s; min-height: 2.7rem;
    }
    .map-btn:active { background: var(--panel); }
    .map-btn.active { color: var(--accent); background: var(--panel); }
    .map-btn .map-icon {
      width: 1.8rem; height: 1.25rem; background: var(--border2); border-radius: 0.15rem;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.55rem; color: var(--muted); flex-shrink: 0;
    }
    .map-btn.active .map-icon { background: rgba(184,165,71,.12); color: var(--accent); }

    /* Layer toggles */
    #layer-toggles { padding: 0.5rem 0.6rem; display: grid; grid-template-columns: repeat(4,1fr); gap: 0.35rem; }
    .layer-toggle {
      display: flex; flex-direction: column; align-items: center; gap: 0.2rem;
      padding: 0.45rem 0.2rem; border-radius: var(--radius);
      border: 1px solid var(--border2); background: var(--panel);
      cursor: pointer; transition: all .15s; min-height: 3.2rem; justify-content: center;
    }
    .layer-toggle.off { opacity: .35; filter: grayscale(.8); }
    .layer-toggle svg { width: 1rem; height: 1rem; flex-shrink: 0; }
    .layer-toggle-label {
      font-family: var(--mono); font-size: 0.42rem; letter-spacing: 0.03rem;
      text-align: center; line-height: 1.2; color: var(--muted);
      max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .layer-toggle:not(.off) .layer-toggle-label { color: var(--text); }
    .layer-toggle-allrow { grid-column: 1/-1; display: flex; gap: 0.35rem; padding: 0 0 0.15rem; }
    .layer-toggle-allrow button {
      flex: 1; padding: 0.3rem; background: var(--panel);
      border: 1px solid var(--border2); color: var(--muted);
      font-family: var(--mono); font-size: 0.55rem; letter-spacing: 0.06rem;
      border-radius: var(--radius); cursor: pointer; transition: all .12s; min-height: 1.6rem;
    }
    .layer-toggle-allrow button:hover { color: var(--accent); border-color: var(--accent); }

    /* Marker list */
    .marker-item {
      padding: 0.55rem 0.85rem; display: flex; align-items: center; gap: 0.5rem;
      cursor: pointer; border-bottom: 1px solid var(--border); min-height: 2.6rem;
    }
    .marker-item:active { background: var(--panel); }
    .marker-item-name { font-size: 0.8rem; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
    .marker-item-cat { font-family: var(--mono); font-size: 0.55rem; color: var(--muted); }

    /* Quest tracker */
    #quest-tracker-panel { padding: 0.5rem 0.6rem; display: flex; flex-direction: column; gap: 0.4rem; }
    .qt-filter-row { display: flex; gap: 0.25rem; flex-wrap: wrap; }
    .qt-filter-btn {
      padding: 0.25rem 0.5rem; font-family: var(--mono); font-size: 0.5rem;
      letter-spacing: 0.06rem; border: 1px solid var(--border2); background: var(--panel);
      color: var(--muted); border-radius: var(--radius); cursor: pointer; transition: all .12s;
    }
    .qt-filter-btn.active { color: var(--accent); border-color: var(--accent); background: rgba(184,165,71,.08); }
    .qt-search {
      width: 100%; padding: 0.4rem 0.6rem; background: var(--panel);
      border: 1px solid var(--border2); color: var(--text);
      font-family: var(--mono); font-size: 0.65rem;
      border-radius: var(--radius); min-height: 2rem;
    }
    .qt-search:focus { outline: none; border-color: var(--accent); }
    .qt-search::placeholder { color: var(--muted); }
    .qt-trader-select {
      width: 100%; padding: 0.35rem 0.6rem; background: var(--panel);
      border: 1px solid var(--border2); color: var(--text);
      font-family: var(--mono); font-size: 0.6rem;
      border-radius: var(--radius); appearance: none; cursor: pointer; min-height: 1.8rem;
    }
    .qt-trader-select:focus { outline: none; border-color: var(--accent); }
    .qt-item {
      display: flex; align-items: center; gap: 0.5rem;
      padding: 0.5rem 0.4rem; border-radius: var(--radius);
      cursor: pointer; transition: background .12s;
      border: 1px solid transparent; margin-bottom: 0.2rem;
    }
    .qt-item:hover { background: var(--panel); }
    .qt-item.status-active { border-color: rgba(74,124,89,.4); background: rgba(74,124,89,.06); }
    .qt-item.status-complete { opacity: .5; }
    .qt-status-btn {
      width: 1.1rem; height: 1.1rem; border-radius: 50%;
      border: 1.5px solid var(--muted); background: none; cursor: pointer;
      flex-shrink: 0; transition: all .12s;
      display: flex; align-items: center; justify-content: center; padding: 0;
    }
    .qt-status-btn.active { border-color: var(--active-col); background: var(--active-col); }
    .qt-status-btn.complete { border-color: var(--complete-col); background: var(--complete-col); }
    .qt-status-btn svg { width: 0.6rem; height: 0.6rem; stroke: #000; fill: none; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; display: none; }
    .qt-status-btn.active svg, .qt-status-btn.complete svg { display: block; }
    .qt-item-info { flex: 1; min-width: 0; }
    .qt-item-name { font-size: 0.72rem; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3; }
    .qt-item.status-complete .qt-item-name { text-decoration: line-through; color: var(--muted); }
    .qt-item-meta { font-family: var(--mono); font-size: 0.5rem; color: var(--muted); margin-top: 0.1rem; }
    .qt-pin-btn {
      width: 1.5rem; height: 1.5rem; background: none; border: none;
      cursor: pointer; color: var(--muted); flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      transition: color .12s; border-radius: 2px;
    }
    .qt-pin-btn:hover { color: var(--accent); }
    .qt-pin-btn.has-pin { color: var(--accent); }
    .qt-pin-btn svg { width: 0.75rem; height: 0.75rem; stroke: currentColor; fill: none; stroke-width: 1.8; }

    /* Quest map markers */
    .quest-map-marker {
      width: 1.75rem; height: 1.75rem; border-radius: 50%;
      background: rgba(232,200,74,.15); border: 2px solid #e8c84a;
      display: flex; align-items: center; justify-content: center;
      color: #e8c84a; box-shadow: 0 2px 8px rgba(0,0,0,.7);
      cursor: pointer; font-family: var(--mono); font-size: 0.55rem; font-weight: bold;
    }
    .quest-map-marker.active { background: rgba(74,124,89,.25); border-color: #4a9e6b; color: #4a9e6b; box-shadow: 0 2px 12px rgba(74,158,107,.4); }
    .quest-map-marker.complete { opacity: .4; }

    /* Buttons */
    .btn-sm {
      padding: 0.4rem 0.6rem; background: var(--panel);
      border: 1px solid var(--border2); color: var(--text);
      font-family: var(--mono); font-size: 0.6rem; letter-spacing: 0.06rem;
      border-radius: var(--radius); cursor: pointer; transition: all .12s; min-height: 2rem;
    }
    .btn-sm:active { opacity: .7; }
    .btn-sm.primary { background: var(--accent); border-color: var(--accent); color: var(--bg); }
    .btn-sm.danger { border-color: var(--danger); color: #e06060; }

    /* ‚îÄ‚îÄ MAIN / MAP ‚îÄ‚îÄ */
    #main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; min-width: 0; }
    #map-view-container { flex: 1; position: relative; background: #0d0f0d; display: flex; flex-direction: column; }
    #map { width: 100%; height: 100%; touch-action: none; }
    .leaflet-container { background: #0d0f0d !important; }
    .leaflet-control-zoom { border: 1px solid var(--border2) !important; box-shadow: none !important; }
    .leaflet-control-zoom a {
      background: var(--surface) !important; color: var(--text) !important;
      border-color: var(--border2) !important;
      font-size: 1.1rem !important;
      width: 2.2rem !important; height: 2.2rem !important; line-height: 2.2rem !important;
    }
    .leaflet-control-zoom a:hover { background: var(--panel) !important; color: var(--accent) !important; }
    .leaflet-control-attribution { display: none !important; }

    #coords-display {
      position: absolute; top: 0.6rem; right: 0.6rem; z-index: 500;
      background: rgba(17,20,18,.85); border: 1px solid var(--border2);
      padding: 0.3rem 0.6rem; font-family: var(--mono); font-size: 0.6rem;
      color: var(--muted); border-radius: var(--radius);
      backdrop-filter: blur(4px); pointer-events: none;
    }
    #edit-hint {
      position: absolute; top: 0.6rem; left: 50%; transform: translateX(-50%);
      z-index: 500; background: rgba(184,165,71,.12); border: 1px solid var(--accent);
      padding: 0.35rem 0.85rem; font-family: var(--mono); font-size: 0.6rem;
      color: var(--accent); border-radius: var(--radius); letter-spacing: 0.06rem;
      display: none; pointer-events: none; white-space: nowrap;
    }
    #edit-hint.show { display: block; }

    /* Quest-pin placement mode banner */
    #quest-pin-hint {
      position: absolute; top: 0.6rem; left: 50%; transform: translateX(-50%);
      z-index: 501; background: rgba(74,158,107,.15); border: 1px solid var(--active-col);
      padding: 0.35rem 0.85rem; font-family: var(--mono); font-size: 0.6rem;
      color: #4a9e6b; border-radius: var(--radius); letter-spacing: 0.06rem;
      display: none; pointer-events: none; white-space: nowrap;
    }
    #quest-pin-hint.show { display: block; }

    .lp-ripple {
      position: absolute; border-radius: 50%; width: 3.75rem; height: 3.75rem; margin: -1.875rem;
      border: 2px solid var(--accent); opacity: 0;
      animation: lp-anim .6s ease-out forwards; pointer-events: none; z-index: 600;
    }
    @keyframes lp-anim { from{transform:scale(.2);opacity:.8} to{transform:scale(1.2);opacity:0} }

    #map-toolbar {
      position: absolute; bottom: 1rem; left: 50%; transform: translateX(-50%);
      z-index: 500; display: flex; gap: 0.25rem;
      background: var(--surface); border: 1px solid var(--border2);
      border-radius: 0.25rem; padding: 0.25rem;
    }
    .tool-btn {
      padding: 0.4rem 0.65rem; background: none; border: 1px solid transparent;
      color: var(--muted); font-family: var(--mono); font-size: 0.6rem;
      letter-spacing: 0.06rem; cursor: pointer; border-radius: 0.15rem;
      transition: all .12s; white-space: nowrap; min-height: 2rem;
    }
    .tool-btn:active { opacity: .7; }
    .tool-btn.active { color: var(--accent); border-color: var(--accent); background: rgba(184,165,71,.08); }

    #map-placeholder {
      position: absolute; inset: 0; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 0.75rem;
      background: #0d0f0d; z-index: 10; pointer-events: none;
    }
    #map-placeholder.hidden { display: none; }
    .placeholder-label { font-family: var(--mono); font-size: 0.65rem; letter-spacing: 0.18rem; color: var(--muted); text-transform: uppercase; }
    .placeholder-grid { width: 7.5rem; height: 5rem; opacity: .08; background-image: linear-gradient(var(--accent) 1px,transparent 1px),linear-gradient(90deg,var(--accent) 1px,transparent 1px); background-size: 1.25rem 1.25rem; }

    #sidebar-toggle {
      position: absolute; right: 0; top: 50%; transform: translateY(-50%);
      z-index: 600; background: var(--surface); border: 1px solid var(--border2);
      border-right: none; width: 0.85rem; height: 2.75rem;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      color: var(--muted); transition: color .12s; border-radius: 0.2rem 0 0 0.2rem;
    }
    #sidebar-toggle:hover { color: var(--accent); }

    .map-marker-icon {
      width: 2rem; height: 2rem; border-radius: 50%;
      background: color-mix(in srgb, var(--mc) 18%, transparent);
      border: 2px solid var(--mc);
      display: flex; align-items: center; justify-content: center;
      color: var(--mc); box-shadow: 0 2px 8px rgba(0,0,0,.7), 0 0 0 1px rgba(0,0,0,.4);
      cursor: pointer; transition: transform .1s;
    }
    .map-marker-icon:active { transform: scale(.9); }
    .map-marker-icon svg { width: 0.875rem; height: 0.875rem; pointer-events: none; }
    .player-location-ring {
      width: 1rem; height: 1rem; border: 2px solid var(--accent);
      border-radius: 50%; animation: ring 1.5s ease-out infinite;
      position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
    }
    @keyframes ring { from{transform:translate(-50%,-50%) scale(.5);opacity:1} to{transform:translate(-50%,-50%) scale(2.5);opacity:0} }

    /* Popups */
    .leaflet-popup-content-wrapper {
      background: var(--surface) !important; border: 1px solid var(--border2) !important;
      border-radius: var(--radius) !important; box-shadow: 0 8px 32px rgba(0,0,0,.7) !important;
      color: var(--text) !important; padding: 0 !important; min-width: 13rem;
    }
    .leaflet-popup-tip-container { display: none !important; }
    .leaflet-popup-close-button { color: var(--muted) !important; font-size: 1.25rem !important; top: 0.5rem !important; right: 0.625rem !important; width: 2rem !important; height: 2rem !important; }
    .leaflet-popup-close-button:hover { color: var(--accent) !important; }
    .popup-inner { padding: 0.875rem 1rem; }
    .popup-cat { font-family: var(--mono); font-size: 0.55rem; letter-spacing: 0.13rem; color: var(--muted); text-transform: uppercase; margin-bottom: 0.25rem; }
    .popup-title { font-family: var(--sans); font-weight: 700; font-size: 1.05rem; color: var(--text); margin-bottom: 0.35rem; }
    .popup-desc { font-size: 0.8rem; color: var(--muted); line-height: 1.6; margin-bottom: 0.6rem; }
    .popup-img { width: 100%; border-radius: 0.15rem; margin-bottom: 0.6rem; border: 1px solid var(--border2); }
    .popup-coords { font-family: var(--mono); font-size: 0.55rem; color: var(--border2); border-top: 1px solid var(--border); padding-top: 0.5rem; margin-top: 0.25rem; }
    .popup-actions { display: flex; gap: 0.35rem; margin-top: 0.6rem; flex-wrap: wrap; }

    /* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
    #modal-overlay {
      display: none; position: fixed; inset: 0; z-index: 2000;
      background: rgba(0,0,0,.7); backdrop-filter: blur(2px);
      align-items: flex-end; justify-content: center;
    }
    #modal-overlay.open { display: flex; }
    #modal {
      background: var(--surface); border: 1px solid var(--border2);
      width: 100%; max-width: 30rem;
      border-radius: 0.75rem 0.75rem 0 0;
      box-shadow: 0 -8px 40px rgba(0,0,0,.8);
      animation: modal-up .2s ease;
      max-height: 92dvh; display: flex; flex-direction: column;
      padding-bottom: var(--safe-b);
    }
    @keyframes modal-up { from{transform:translateY(1.875rem);opacity:0} to{transform:none;opacity:1} }
    .modal-drag-handle { width: 2.25rem; height: 0.25rem; background: var(--border2); border-radius: 0.125rem; margin: 0.6rem auto 0.125rem; flex-shrink: 0; }
    .modal-header { padding: 0.6rem 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .modal-title { font-family: var(--mono); font-size: 0.65rem; letter-spacing: 0.13rem; color: var(--accent); }
    .modal-close { background: none; border: none; color: var(--muted); font-size: 1.375rem; cursor: pointer; width: 2.25rem; height: 2.25rem; display: flex; align-items: center; justify-content: center; }
    .modal-close:hover { color: var(--text); }
    .modal-body { padding: 0.875rem 1rem; display: flex; flex-direction: column; gap: 0.7rem; overflow-y: auto; flex: 1; }
    .form-group { display: flex; flex-direction: column; gap: 0.3rem; }
    .form-label { font-family: var(--mono); font-size: 0.55rem; letter-spacing: 0.09rem; color: var(--muted); text-transform: uppercase; }
    .form-input, .form-select, .form-textarea {
      padding: 0.6rem 0.75rem; background: var(--panel); border: 1px solid var(--border2);
      color: var(--text); font-family: var(--sans); font-size: 0.9rem;
      border-radius: var(--radius); min-height: 2.75rem;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); }
    .form-select { appearance: none; cursor: pointer; }
    .form-textarea { resize: vertical; min-height: 5rem; }
    .form-input::placeholder, .form-textarea::placeholder { color: var(--muted); }
    .modal-footer { padding: 0.75rem 1rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.5rem; flex-shrink: 0; }
    .modal-footer .btn-sm { min-height: 2.75rem; padding: 0 1.125rem; font-size: 0.65rem; }
    #img-drop {
      border: 1px dashed var(--border2); border-radius: var(--radius);
      padding: 0.875rem; text-align: center; cursor: pointer;
      font-family: var(--mono); font-size: 0.6rem; color: var(--muted);
      min-height: 3rem; display: flex; align-items: center; justify-content: center; transition: all .12s;
    }
    #img-drop.drag-over { border-color: var(--accent); background: rgba(184,165,71,.04); color: var(--text); }
    #img-preview { display: none; width: 100%; border-radius: 0.15rem; margin-top: 0.35rem; max-height: 8.75rem; object-fit: cover; }

    /* Quest-pin-on-map: small confirmation sheet */
    #qpin-confirm {
      display: none; position: fixed; inset: 0; z-index: 2100;
      background: rgba(0,0,0,.75); backdrop-filter: blur(2px);
      align-items: flex-end; justify-content: center;
    }
    #qpin-confirm.open { display: flex; }
    #qpin-confirm-inner {
      background: var(--surface); border: 1px solid var(--border2);
      width: 100%; max-width: 30rem; border-radius: 0.75rem 0.75rem 0 0;
      box-shadow: 0 -8px 40px rgba(0,0,0,.8); animation: modal-up .2s ease;
      padding-bottom: var(--safe-b);
    }
    .qpc-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .qpc-title { font-family: var(--mono); font-size: 0.65rem; letter-spacing: 0.13rem; color: var(--active-col); }
    .qpc-body { padding: 0.75rem 1rem; display: flex; flex-direction: column; gap: 0.5rem; }
    .qpc-search { width: 100%; padding: 0.5rem 0.6rem; background: var(--panel); border: 1px solid var(--border2); color: var(--text); font-family: var(--mono); font-size: 0.65rem; border-radius: var(--radius); }
    .qpc-search:focus { outline: none; border-color: var(--accent); }
    .qpc-search::placeholder { color: var(--muted); }
    .qpc-list { max-height: 12rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.2rem; }
    .qpc-item { padding: 0.5rem 0.6rem; border-radius: var(--radius); cursor: pointer; transition: background .1s; border: 1px solid transparent; }
    .qpc-item:hover { background: var(--panel); border-color: var(--border2); }
    .qpc-item.selected { border-color: var(--accent); background: rgba(184,165,71,.06); }
    .qpc-item-name { font-size: 0.78rem; color: var(--text); line-height: 1.3; }
    .qpc-item-meta { font-family: var(--mono); font-size: 0.5rem; color: var(--muted); }
    .qpc-notes { width: 100%; padding: 0.5rem 0.6rem; background: var(--panel); border: 1px solid var(--border2); color: var(--text); font-family: var(--sans); font-size: 0.8rem; border-radius: var(--radius); min-height: 3.5rem; resize: vertical; }
    .qpc-notes:focus { outline: none; border-color: var(--accent); }
    .qpc-notes::placeholder { color: var(--muted); }
    .qpc-footer { padding: 0.6rem 1rem; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; flex-wrap: wrap; }

    /* ‚îÄ‚îÄ CONTENT VIEWS ‚îÄ‚îÄ */
    #content-area { display: none; flex-direction: column; flex: 1; overflow: hidden; }
    #content-area.active { display: flex; }

    /* Market */
    .mkt-wrap { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
    .mkt-header { padding: 0.6rem 0.875rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.6rem; flex-shrink: 0; flex-wrap: wrap; }
    .mkt-header-label { font-family: var(--mono); font-size: 0.65rem; letter-spacing: 0.13rem; color: var(--muted); white-space: nowrap; flex-shrink: 0; }
    .mkt-search { flex: 1; min-width: 6rem; padding: 0.5rem 0.6rem; background: var(--panel); border: 1px solid var(--border2); color: var(--text); font-family: var(--mono); font-size: 0.7rem; border-radius: var(--radius); min-height: 2.25rem; }
    .mkt-search:focus { outline: none; border-color: var(--accent); }
    .mkt-search::placeholder { color: var(--muted); }
    .mkt-scroll { flex: 1; overflow: auto; -webkit-overflow-scrolling: touch; }
    .mkt-table { width: 100%; border-collapse: collapse; }
    .mkt-table th { padding: 0.5rem 0.75rem; text-align: left; font-family: var(--mono); font-size: 0.6rem; letter-spacing: 0.06rem; color: var(--muted); border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--panel); white-space: nowrap; z-index: 2; }
    .mkt-table td { padding: 0.35rem 0.75rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
    .mkt-table tr:hover td { background: var(--panel); }
    .mkt-icon { width: 1.75rem; height: 1.75rem; object-fit: contain; opacity: .85; display: block; }
    .mkt-name-primary { font-size: 0.82rem; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 16rem; display: block; }
    .mkt-name-secondary { font-size: 0.65rem; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 16rem; display: block; margin-top: 0.1rem; }
    .mkt-cat { font-family: var(--mono); font-size: 0.6rem; color: var(--muted); }
    .mkt-price { font-family: var(--mono); font-size: 0.7rem; color: var(--accent); white-space: nowrap; }
    .mkt-price-low { font-family: var(--mono); font-size: 0.7rem; color: var(--text); white-space: nowrap; }
    .mkt-change { font-family: var(--mono); font-size: 0.65rem; white-space: nowrap; }
    @media(max-width:700px){ .mkt-col-low,.mkt-col-cat{display:none} }
    @media(max-width:480px){ .mkt-col-change{display:none} }

    /* Quests page */
    .quests-wrap { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
    .quests-header { padding: 0.6rem 0.875rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; flex-wrap: wrap; }
    .quests-grid { flex: 1; overflow-y: auto; padding: 0.6rem; display: grid; grid-template-columns: repeat(auto-fill,minmax(15rem,1fr)); gap: 0.5rem; align-content: start; }
    .quest-card { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.75rem; position: relative; transition: border-color .15s; }
    .quest-card.status-active { border-color: rgba(74,124,89,.5); }
    .quest-card.status-complete { opacity: .55; }
    .quest-card-header { display: flex; justify-content: space-between; gap: 0.5rem; margin-bottom: 0.25rem; }
    .quest-card-name { font-family: var(--sans); font-weight: 700; font-size: 0.85rem; color: var(--text); line-height: 1.3; }
    .quest-card-lvl { font-family: var(--mono); font-size: 0.55rem; color: var(--accent); white-space: nowrap; flex-shrink: 0; }
    .quest-card-trader { font-family: var(--mono); font-size: 0.6rem; color: var(--muted); margin-bottom: 0.35rem; }
    .quest-card-objectives { font-size: 0.72rem; color: var(--muted); }
    .quest-card-objectives div { margin-bottom: 0.125rem; }
    .quest-card-exp { font-family: var(--mono); font-size: 0.6rem; color: var(--accent2); margin-top: 0.5rem; }
    .quest-card-actions { display: flex; gap: 0.3rem; margin-top: 0.5rem; flex-wrap: wrap; }
    .quest-card-actions .btn-sm { font-size: 0.55rem; padding: 0.25rem 0.5rem; min-height: 1.75rem; }
    .quest-status-badge { font-family: var(--mono); font-size: 0.5rem; letter-spacing: 0.06rem; padding: 0.125rem 0.375rem; border-radius: 0.15rem; position: absolute; top: 0.6rem; right: 0.6rem; }
    .quest-status-badge.active { background: rgba(74,124,89,.2); color: #4a9e6b; border: 1px solid rgba(74,124,89,.4); }
    .quest-status-badge.complete { background: rgba(42,74,58,.2); color: #6aaa8a; border: 1px solid rgba(106,170,138,.3); }

    /* Toast */
    #toast {
      position: fixed; bottom: 1.25rem; left: 50%;
      transform: translateX(-50%) translateY(0.625rem);
      z-index: 3000; background: var(--surface); border: 1px solid var(--border2);
      padding: 0.5rem 1.125rem; border-radius: var(--radius);
      font-family: var(--mono); font-size: 0.65rem; color: var(--text);
      opacity: 0; transition: all .2s; pointer-events: none; white-space: nowrap;
    }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    #toast.error { border-color: var(--danger); color: #e06060; }
    .edit-mode-active #map { cursor: crosshair !important; }
    .quest-pin-mode #map { cursor: crosshair !important; }

    /* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
    @media(max-width:640px) {
      html { font-size: 14px; }
      #bot-nav { display: block; }
      .nav-tabs { display: none; }
      .nav-status { display: none; }
      #nav-logo { border-right: none; padding-right: 0.5rem; }
      #mobile-menu-btn { display: flex; }
      #nav-right { display: none; }
      #sidebar {
        position: fixed; top: 0; bottom: 0; right: 0; left: auto;
        width: var(--sidebar-w) !important;
        transform: translateX(110%);
        transition: transform .25s ease; z-index: 950;
        padding-top: var(--nav-h);
        padding-bottom: calc(var(--safe-b) + 0.5rem);
        overflow-y: auto !important; -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
        border-left: 1px solid var(--border); border-right: none;
      }
      #sidebar.mobile-open { transform: translateX(0); }
      #sidebar.collapsed { width: var(--sidebar-w) !important; overflow-y: auto !important; }
      #sidebar-toggle { display: none; }
      #app { bottom: calc(var(--bot-nav-h) + var(--safe-b)); }
      #coords-display { display: none; }
      #map-toolbar { bottom: 0.6rem; }
      #toast { bottom: calc(var(--bot-nav-h) + var(--safe-b) + 0.75rem); }
    }
  </style>
</head>
<body>

<!-- TOP NAV -->
<nav id="nav">
  <div id="nav-logo">INTEL<span>CENTER</span></div>
  <div class="nav-tabs">
    <div class="nav-tab active" data-view="map" onclick="switchView('map')"><span class="dot"></span>MAPS</div>
    <div class="nav-tab" data-view="market" onclick="switchView('market')"><span class="dot"></span>MARKET</div>
    <div class="nav-tab" data-view="quests" onclick="switchView('quests')"><span class="dot"></span>QUESTS</div>
  </div>
  <div id="nav-right">
    <div class="nav-status"><span class="status-dot"></span>API LIVE</div>
    <div class="nav-status" id="nav-wipe" style="color:var(--accent)">‚îÄ‚îÄ</div>
  </div>
  <button id="mobile-menu-btn" onclick="toggleMobileSidebar()" aria-label="Menu">
    <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
  </button>
</nav>

<div id="app">
  <div id="sidebar-overlay" onclick="closeMobileSidebar()"></div>

  <div id="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-section-header" onclick="toggleSection(this)">MAPS <span style="font-size:0.5rem">‚ñº</span></div>
      <div class="sidebar-section-body" id="map-list"></div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-header" onclick="toggleSection(this)">LAYERS <span style="font-size:0.5rem">‚ñº</span></div>
      <div class="sidebar-section-body" id="layer-toggles"></div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-header" onclick="toggleSection(this)">
        QUEST TRACKER
        <span id="qt-active-count" style="font-family:var(--mono);font-size:0.5rem;color:var(--accent2);margin-left:auto;margin-right:0.4rem;"></span>
        <span style="font-size:0.5rem">‚ñº</span>
      </div>
      <div class="sidebar-section-body" id="quest-tracker-panel">
        <div class="qt-filter-row">
          <button class="qt-filter-btn active" data-qtf="all" onclick="setQuestFilter('all')">ALL</button>
          <button class="qt-filter-btn" data-qtf="active" onclick="setQuestFilter('active')">ACTIVE</button>
          <button class="qt-filter-btn" data-qtf="available" onclick="setQuestFilter('available')">AVAILABLE</button>
          <button class="qt-filter-btn" data-qtf="complete" onclick="setQuestFilter('complete')">DONE</button>
        </div>
        <select class="qt-trader-select" id="qt-trader-select" onchange="renderQuestTracker()">
          <option value="">ALL TRADERS</option>
        </select>
        <input class="qt-search" id="qt-search" placeholder="Search quests..." oninput="renderQuestTracker()" />
        <div id="qt-list" style="max-height:20rem;overflow-y:auto;margin:0 -0.25rem;padding:0 0.25rem"></div>
        <div style="font-family:var(--mono);font-size:0.5rem;color:var(--border2);line-height:1.7;margin-top:0.25rem;">
          Click ‚óè to cycle status &nbsp;¬∑&nbsp; Click üìç to set/go to map pin<br>
          Click the map in ADD QUEST PIN mode to drop a pin
        </div>
      </div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-header" onclick="toggleSection(this)">MARKERS <span id="marker-count" style="font-family:var(--mono);font-size:0.5rem;">0</span></div>
      <div class="sidebar-section-body" id="marker-list"></div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-header" onclick="toggleSection(this)">LOCATE ME <span style="font-size:0.5rem">‚ñº</span></div>
      <div class="sidebar-section-body" style="padding:0.6rem 0.75rem;">
        <div style="font-family:var(--mono);font-size:0.55rem;color:var(--muted);margin-bottom:0.35rem;line-height:1.6;">
          Paste F1 coords or screenshot filename:<br>
          <span style="color:var(--border2);">e.g. 235.0, 5.2, -104.3</span>
        </div>
        <input type="text" id="loc-paste" placeholder="X, Y, Z"
          style="width:100%;padding:0.55rem 0.6rem;background:var(--panel);border:1px solid var(--border2);color:var(--text);font-family:var(--mono);font-size:0.7rem;border-radius:var(--radius);min-height:2.4rem;"
          oninput="onCoordInput(this)" onkeydown="if(event.key==='Enter')locatePlayer()" />
        <div id="coord-parse-preview" style="font-family:var(--mono);font-size:0.55rem;color:var(--accent);margin-top:0.3rem;min-height:0.875rem;"></div>
        <div style="display:flex;gap:0.35rem;margin-top:0.5rem;">
          <button class="btn-sm primary" onclick="locatePlayer();closeMobileSidebar();" style="flex:1;">LOCATE</button>
          <button class="btn-sm" onclick="clearPlayerMarker()">CLR</button>
        </div>
      </div>
    </div>
  </div>

  <div id="main">
    <div id="map-view-container">
      <div id="map-placeholder"><div class="placeholder-grid"></div><div class="placeholder-label">SELECT A MAP</div></div>
      <div id="map"></div>
      <div id="coords-display">‚îÄ‚îÄ</div>
      <div id="edit-hint">LONG-PRESS / RIGHT-CLICK TO ADD MARKER</div>
      <div id="quest-pin-hint">CLICK MAP TO DROP QUEST PIN ‚Äî ESC TO CANCEL</div>
      <div id="map-toolbar">
        <button class="tool-btn" id="btn-edit" onclick="toggleEditMode()">‚úõ ADD</button>
        <button class="tool-btn" id="btn-quest-pin" onclick="toggleQuestPinMode()">üìç QUEST PIN</button>
        <button class="tool-btn" id="btn-fit" onclick="fitMap()">‚ä° FIT</button>
        <button class="tool-btn" id="btn-clear-player" onclick="clearPlayerMarker()" style="display:none">‚ä† POS</button>
      </div>
      <button id="sidebar-toggle" onclick="toggleSidebar()">‚Ä∫</button>
    </div>
    <div id="content-area"></div>
  </div>
</div>

<!-- BOTTOM NAV -->
<div id="bot-nav"><div id="bot-nav-inner">
  <button class="bot-tab active" data-view="map" onclick="switchView('map')">
    <svg viewBox="0 0 24 24"><polygon points="3,6 9,3 15,6 21,3 21,18 15,21 9,18 3,21"/><line x1="9" y1="3" x2="9" y2="18"/><line x1="15" y1="6" x2="15" y2="21"/></svg>MAPS
  </button>
  <button class="bot-tab" data-view="market" onclick="switchView('market')">
    <svg viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>MARKET
  </button>
  <button class="bot-tab" data-view="quests" onclick="switchView('quests')">
    <svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>QUESTS
  </button>
</div></div>

<!-- MARKER MODAL -->
<div id="modal-overlay">
  <div id="modal">
    <div class="modal-drag-handle"></div>
    <div class="modal-header">
      <span class="modal-title" id="modal-title-text">ADD MARKER</span>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Name</label><input class="form-input" id="m-name" placeholder="e.g. Marked Room Key Spawn" /></div>
      <div class="form-group">
        <label class="form-label">Category</label>
        <select class="form-select" id="m-cat" style="background:var(--panel);border:1px solid var(--border2);color:var(--text);">
          <optgroup label="‚îÄ‚îÄ Spawns & Extracts">
            <option value="pmc_spawn">PMC Spawn</option><option value="pmc_exfil">PMC Extract</option>
            <option value="scav_spawn">Scav Spawn</option><option value="scav_exfil">Scav Extract</option><option value="boss">Boss Spawn</option>
          </optgroup>
          <optgroup label="‚îÄ‚îÄ Quests & Doors"><option value="quest">Quest</option><option value="locked_door">Locked Door</option></optgroup>
          <optgroup label="‚îÄ‚îÄ Loot">
            <option value="loot_med">Medical</option><option value="loot_tech">Technical</option><option value="loot_elec">Electrical</option>
            <option value="loot_food">Food & Water</option><option value="loot_weapon">Weapons & Mods</option><option value="loot_ammo">Ammo</option>
            <option value="loot_valuables">Valuables</option><option value="loot_misc">Loose Loot</option>
          </optgroup>
          <optgroup label="‚îÄ‚îÄ Other"><option value="stash">Stash / Cache</option><option value="hazard">Hazard / Mine</option></optgroup>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="m-desc" placeholder="Notes, tips, requirements..."></textarea></div>
      <div class="form-group">
        <label class="form-label">Image (optional)</label>
        <div id="img-drop" onclick="document.getElementById('img-file').click()" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="handleImgDrop(event)">TAP TO UPLOAD IMAGE</div>
        <input type="file" id="img-file" accept="image/*" style="display:none" onchange="handleImgSelect(event)" />
        <img id="img-preview" alt="preview" />
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-sm" onclick="closeModal()">CANCEL</button>
      <button class="btn-sm primary" onclick="saveMarker()">SAVE</button>
    </div>
  </div>
</div>

<!-- QUEST PIN CONFIRMATION (after clicking map) -->
<div id="qpin-confirm">
  <div id="qpin-confirm-inner">
    <div class="modal-drag-handle"></div>
    <div class="qpc-header">
      <span class="qpc-title">ASSIGN QUEST PIN</span>
      <button class="modal-close" onclick="cancelQuestPin()">√ó</button>
    </div>
    <div class="qpc-body">
      <div style="font-family:var(--mono);font-size:0.55rem;color:var(--muted);" id="qpc-coords-display">Pin at: ‚îÄ‚îÄ</div>
      <input class="qpc-search" id="qpc-search" placeholder="Search quest to assign..." oninput="renderQpcList()" />
      <div class="qpc-list" id="qpc-list"></div>
      <textarea class="qpc-notes" id="qpc-notes" placeholder="Notes: floor, room, objective details..."></textarea>
    </div>
    <div class="qpc-footer">
      <button class="btn-sm danger" id="qpc-remove-btn" onclick="removeQuestPinById()" style="display:none">REMOVE PIN</button>
      <div style="display:flex;gap:0.5rem;margin-left:auto">
        <button class="btn-sm" onclick="cancelQuestPin()">CANCEL</button>
        <button class="btn-sm primary" onclick="confirmQuestPin()">SAVE PIN</button>
      </div>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const TARKOV_API='https://api.tarkov.dev/graphql';

// ‚îÄ‚îÄ CATEGORY CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CATEGORY_CONFIG={
  pmc_spawn:{color:'#9b6fce',label:'PMC Spawn',svg:'<path d="M12 2l0 10M12 2l-4 5M12 2l4 5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="18" r="4" fill="currentColor" opacity=".3"/>'},
  pmc_exfil:{color:'#4a9e6b',label:'PMC Extract',svg:'<rect x="3" y="3" width="10" height="16" rx="1"/><path d="M13 8l5 4-5 4"/><line x1="18" y1="12" x2="9" y2="12" stroke-linecap="round"/>'},
  scav_spawn:{color:'#7a6a3a',label:'Scav Spawn',svg:'<path d="M12 2l0 10M12 2l-4 5M12 2l4 5" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="2 1"/><circle cx="12" cy="18" r="4" fill="currentColor" opacity=".3"/>'},
  scav_exfil:{color:'#6a8a4a',label:'Scav Extract',svg:'<rect x="3" y="3" width="10" height="16" rx="1"/><path d="M13 8l5 4-5 4" stroke-dasharray="2 1"/><line x1="18" y1="12" x2="9" y2="12" stroke-linecap="round" stroke-dasharray="2 1"/>'},
  locked_door:{color:'#b8a547',label:'Locked Door',svg:'<rect x="8" y="11" width="8" height="8" rx="1"/><path d="M10 11V8a2 2 0 014 0v3"/><circle cx="12" cy="15" r="1" fill="currentColor"/>'},
  quest:{color:'#e8c84a',label:'Quest',svg:'<path d="M12 3a4 4 0 013 6.65c-.5.57-1 1.1-1 1.85V13"/><circle cx="12" cy="17" r="1" fill="currentColor"/>'},
  loot_med:{color:'#e05a5a',label:'Medical',svg:'<rect x="9" y="3" width="6" height="18" rx="1"/><rect x="3" y="9" width="18" height="6" rx="1"/>'},
  loot_tech:{color:'#5a8ae0',label:'Technical',svg:'<path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3-3a1 1 0 000-1.4l-1.6-1.6a1 1 0 00-1.4 0z"/><path d="M5 20L2 22l2-3 9.9-9.9"/><line x1="13" y1="7" x2="7" y2="13"/>'},
  loot_elec:{color:'#e0c84a',label:'Electrical',svg:'<polygon points="13,2 3,14 12,14 11,22 21,10 12,10"/>'},
  loot_food:{color:'#8ae08a',label:'Food & Water',svg:'<path d="M18 8h1a4 4 0 010 8h-1"/><path d="M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/>'},
  loot_weapon:{color:'#c07a3a',label:'Weapons & Mods',svg:'<path d="M3 12h14l3-3-2-2H5l-3 3 1 2z"/><line x1="8" y1="12" x2="8" y2="16"/><rect x="6" y="16" width="4" height="2" rx=".5"/>'},
  loot_ammo:{color:'#e08a3a',label:'Ammo',svg:'<rect x="10" y="2" width="4" height="12" rx="2"/><path d="M10 14h4l1 3H9z"/><line x1="12" y1="17" x2="12" y2="22"/>'},
  loot_valuables:{color:'#c8a8e8',label:'Valuables',svg:'<polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>'},
  loot_misc:{color:'#5a6b5a',label:'Loose Loot',svg:'<circle cx="9" cy="9" r="2"/><circle cx="15" cy="9" r="2"/><circle cx="12" cy="15" r="2"/><line x1="9" y1="9" x2="15" y2="9"/><line x1="9" y1="9" x2="12" y2="15"/><line x1="15" y1="9" x2="12" y2="15"/>'},
  stash:{color:'#8a7a5a',label:'Stash / Cache',svg:'<rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="10" y1="14" x2="14" y2="14"/>'},
  hazard:{color:'#c03a3a',label:'Hazard / Mine',svg:'<path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17" stroke-width="2" stroke-linecap="round"/>'},
  boss:{color:'#e05a8a',label:'Boss Spawn',svg:'<path d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6z"/>'},
};
const categoryVisible=Object.fromEntries(Object.keys(CATEGORY_CONFIG).map(k=>[k,true]));

const MAPS=[
  {id:'customs',name:'Customs',short:'CUS',img:'./customs.png',bounds:{minX:-371,maxX:698,minZ:-307,maxZ:237}},
  {id:'woods',name:'Woods',short:'WDS',img:'./woods.png',bounds:{minX:-695,maxX:650,minZ:-945,maxZ:470}},
  {id:'factory',name:'Factory',short:'FAC',img:'./factory.png',bounds:{minX:-67,maxX:77,minZ:-66,maxZ:70}},
  {id:'interchange',name:'Interchange',short:'INT',img:'./interchange.png',bounds:{minX:-364,maxX:530,minZ:-439,maxZ:452},floors:['Ground','Mall','Roof']},
  {id:'shoreline',name:'Shoreline',short:'SHR',img:'./shoreline.png',bounds:{minX:-480,maxX:430,minZ:-580,maxZ:380}},
  {id:'reserve',name:'Reserve',short:'RSV',img:'./reserve.png',bounds:{minX:-415,maxX:370,minZ:-375,maxZ:400}},
  {id:'lighthouse',name:'Lighthouse',short:'LGT',img:'./lighthouse.png',bounds:{minX:-680,maxX:540,minZ:-680,maxZ:400}},
  {id:'streets',name:'Streets',short:'STR',img:'./streets.png',bounds:{minX:-415,maxX:330,minZ:-430,maxZ:310},floors:['Ground','Floor 2','Floor 3','Roof']},
  {id:'ground-zero',name:'Ground Zero',short:'GZR',img:'./groundzero.png',bounds:{minX:-250,maxX:250,minZ:-250,maxZ:250},floors:['Underground','Ground','Floor 2','Floor 3']},
  {id:'the-lab',name:'The Lab',short:'LAB',img:'./thelab.png',bounds:{minX:-115,maxX:115,minZ:-95,maxZ:115},floors:['Floor 1','Floor 2']},
  {id:'terminal',name:'Terminal',short:'TRM',img:'./terminal.png',bounds:{minX:-300,maxX:300,minZ:-300,maxZ:300}},
  {id:'labyrinth',name:'Labyrinth',short:'LBR',img:'./labryinth.png',bounds:{minX:-200,maxX:200,minZ:-200,maxZ:200}},
];

const isMobile=()=>window.matchMedia('(max-width:640px)').matches;

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let state={activeMap:null,activeView:'map',editMode:false,questPinMode:false,pendingLatLng:null,pendingImgDataUrl:null,playerMarker:null,sidebarOpen:true};
let leafletMap=null,markersLayer=null,questMarkersLayer=null,imageOverlay=null;
let lpTimer=null,lpStartPos=null,lpActivePointerId=null;
// pending quest pin from map click
let _pendingQuestPinLatLng=null;
let _qpcSelectedQid=null;

// ‚îÄ‚îÄ QUEST STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let questData=[];
let questStatuses={};
let questPins={};
let questFilter='all';

function loadQuestState(){
  try{questStatuses=JSON.parse(localStorage.getItem('ic_quest_statuses'))||{};}catch(e){questStatuses={};}
  try{questPins=JSON.parse(localStorage.getItem('ic_quest_pins'))||{};}catch(e){questPins={};}
}
function saveQuestState(){
  localStorage.setItem('ic_quest_statuses',JSON.stringify(questStatuses));
  localStorage.setItem('ic_quest_pins',JSON.stringify(questPins));
}
function getQuestStatus(id){return questStatuses[id]||'none';}
function setQuestStatus(id,status){
  if(status==='none')delete questStatuses[id];
  else questStatuses[id]=status;
  saveQuestState();
  renderQuestTracker();
  renderQuestMapMarkers();
  updateActiveQuestCount();
}
function cycleQuestStatus(id){
  const cur=getQuestStatus(id);
  setQuestStatus(id,cur==='none'?'active':cur==='active'?'complete':'none');
}
function updateActiveQuestCount(){
  const n=Object.values(questStatuses).filter(v=>v==='active').length;
  const el=document.getElementById('qt-active-count');
  if(el)el.textContent=n>0?`${n} active`:'';
}

// ‚îÄ‚îÄ QUEST TRACKER SIDEBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setQuestFilter(f){
  questFilter=f;
  document.querySelectorAll('.qt-filter-btn').forEach(b=>b.classList.toggle('active',b.dataset.qtf===f));
  renderQuestTracker();
}
function renderQuestTracker(){
  const list=document.getElementById('qt-list');
  if(!questData.length){list.innerHTML=`<div style="font-family:var(--mono);font-size:0.55rem;color:var(--muted);padding:0.5rem 0.25rem;">Loading quests...</div>`;return;}
  const search=(document.getElementById('qt-search')?.value||'').toLowerCase();
  const trader=document.getElementById('qt-trader-select')?.value||'';
  const filtered=questData.filter(q=>{
    const st=getQuestStatus(q.id);
    if(questFilter==='active'&&st!=='active')return false;
    if(questFilter==='complete'&&st!=='complete')return false;
    if(questFilter==='available'&&st!=='none')return false;
    if(trader&&q.trader.name!==trader)return false;
    if(search&&!q.name.toLowerCase().includes(search)&&!q.trader.name.toLowerCase().includes(search))return false;
    return true;
  });
  if(!filtered.length){list.innerHTML=`<div style="font-family:var(--mono);font-size:0.55rem;color:var(--muted);padding:0.5rem 0.25rem;">No quests match filter.</div>`;return;}
  list.innerHTML=filtered.map(q=>{
    const st=getQuestStatus(q.id);
    const pin=questPins[q.id];
    const chk='<path d="M5 12l5 5L20 7"/>';
    return`<div class="qt-item status-${st}" data-qid="${q.id}">
      <button class="qt-status-btn ${st}" onclick="cycleQuestStatus('${q.id}')" title="Cycle: none‚Üíactive‚Üícomplete">
        <svg viewBox="0 0 24 24">${st!=='none'?chk:''}</svg>
      </button>
      <div class="qt-item-info" onclick="goToQuestPin('${q.id}')">
        <div class="qt-item-name">${escHtml(q.name)}</div>
        <div class="qt-item-meta">${q.trader.name} ¬∑ LVL ${q.minPlayerLevel}${pin?' ¬∑ üìç '+( MAPS.find(m=>m.id===pin.mapId)?.name||'?'):''}${st==='active'?' ¬∑ <span style="color:#4a9e6b">ACTIVE</span>':st==='complete'?' ¬∑ <span style="color:#6aaa8a">DONE</span>':''}</div>
      </div>
      <button class="qt-pin-btn ${pin?'has-pin':''}" onclick="openQuestPinModal('${q.id}')" title="${pin?'Edit pin':'Set map pin'}">
        <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><circle cx="12" cy="9" r="2.5" fill="currentColor" opacity=".6"/></svg>
      </button>
    </div>`;
  }).join('');
}
function populateQuestTraderFilter(){
  const traders=[...new Set(questData.map(q=>q.trader.name))].sort();
  const sel=document.getElementById('qt-trader-select');
  if(!sel)return;
  const cur=sel.value;
  sel.innerHTML=`<option value="">ALL TRADERS</option>${traders.map(t=>`<option value="${t}">${t}</option>`).join('')}`;
  sel.value=cur;
}

// ‚îÄ‚îÄ QUEST MAP MARKERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderQuestMapMarkers(){
  if(!questMarkersLayer)return;
  questMarkersLayer.clearLayers();
  if(!categoryVisible['quest'])return;
  Object.entries(questPins).forEach(([qid,pin])=>{
    if(!pin||pin.mapId!==state.activeMap)return;
    const quest=questData.find(q=>q.id===qid);if(!quest)return;
    const st=getQuestStatus(qid);
    const icon=L.divIcon({
      html:`<div class="quest-map-marker ${st}" title="${escHtml(quest.name)}">${st==='active'?'‚òÖ':'?'}</div>`,
      className:'',iconSize:[28,28],iconAnchor:[14,14]
    });
    L.marker([pin.z,pin.x],{icon,zIndexOffset:500}).addTo(questMarkersLayer).on('click',()=>showQuestPopup(quest,pin));
  });
}
function showQuestPopup(quest,pin){
  const st=getQuestStatus(quest.id);
  L.popup({maxWidth:280,closeButton:true}).setLatLng([pin.z,pin.x]).setContent(`<div class="popup-inner">
    <div class="popup-cat" style="color:#e8c84a">QUEST</div>
    <div class="popup-title">${escHtml(quest.name)}</div>
    <div style="font-family:var(--mono);font-size:0.55rem;color:var(--muted);margin-bottom:0.35rem;">${quest.trader.name} ¬∑ LVL ${quest.minPlayerLevel}</div>
    ${pin.notes?`<div class="popup-desc" style="margin-bottom:0.35rem;">${escHtml(pin.notes)}</div>`:''}
    <div class="popup-actions">
      <button class="btn-sm" onclick="setQuestStatus('${quest.id}','${st==='active'?'none':'active'}')">${st==='active'?'DEACTIVATE':'SET ACTIVE'}</button>
      <button class="btn-sm" style="${st==='complete'?'color:var(--complete-col);border-color:var(--complete-col)':''}" onclick="setQuestStatus('${quest.id}','${st==='complete'?'none':'complete'}')">${st==='complete'?'UNMARK':'COMPLETE'}</button>
      <button class="btn-sm" onclick="openQuestPinModal('${quest.id}')">EDIT PIN</button>
    </div>
  </div>`).openOn(leafletMap);
}
function goToQuestPin(qid){
  const pin=questPins[qid];if(!pin){toast('No map pin ‚Äî click üìç to add one');return;}
  switchView('map');closeMobileSidebar();
  if(pin.mapId!==state.activeMap){selectMap(pin.mapId);setTimeout(()=>leafletMap.flyTo([pin.z,pin.x],1,{duration:.7}),400);}
  else{leafletMap.flyTo([pin.z,pin.x],1,{duration:.6});}
}

// ‚îÄ‚îÄ QUEST PIN MODAL (üìç button handler) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// If quest already has a pin ‚Üí open the edit/confirm sheet directly (no map click needed)
// If no pin yet ‚Üí switch to map view and enter click-to-place mode
function openQuestPinModal(qid){
  const pin=questPins[qid];
  if(pin){
    // Already has a pin ‚Äî open the sheet directly with the existing location
    _pendingQuestPinLatLng={lat:pin.z,lng:pin.x};
    _qpcSelectedQid=qid;
    // Navigate to the right map so user can see it
    switchView('map');
    closeMobileSidebar();
    if(pin.mapId!==state.activeMap)selectMap(pin.mapId);
    // Show the confirm/edit sheet
    document.getElementById('qpc-coords-display').textContent=
      `Pin at: X=${pin.x}, Z=${pin.z} on ${MAPS.find(m=>m.id===pin.mapId)?.name||pin.mapId} ‚Äî click map to move`;
    document.getElementById('qpc-search').value=questData.find(q=>q.id===qid)?.name||'';
    document.getElementById('qpc-notes').value=pin.notes||'';
    document.getElementById('qpc-remove-btn').style.display='';
    renderQpcList();
    document.getElementById('qpin-confirm').classList.add('open');
  } else {
    // No pin ‚Äî go to map, enter click-to-place mode with this quest pre-selected
    switchView('map');
    closeMobileSidebar();
    toast('Click the map to place the quest pin');
    enterQuestPinMode(qid);
  }
}

// ‚îÄ‚îÄ QUEST PIN MODE (click-on-map) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleQuestPinMode(){
  if(state.questPinMode)exitQuestPinMode();
  else enterQuestPinMode(null);
}
function enterQuestPinMode(preSelectedQid){
  // exit regular edit mode if on
  if(state.editMode)toggleEditMode();
  state.questPinMode=true;
  document.getElementById('btn-quest-pin').classList.add('active');
  document.getElementById('quest-pin-hint').classList.add('show');
  document.getElementById('map-view-container').classList.add('quest-pin-mode');
  _preSelectedQuestPinQid=preSelectedQid||null;
}
function exitQuestPinMode(){
  state.questPinMode=false;
  document.getElementById('btn-quest-pin').classList.remove('active');
  document.getElementById('quest-pin-hint').classList.remove('show');
  document.getElementById('map-view-container').classList.remove('quest-pin-mode');
  _preSelectedQuestPinQid=null;
}
let _preSelectedQuestPinQid=null;

function handleQuestPinClick(latlng){
  _pendingQuestPinLatLng=latlng;
  _qpcSelectedQid=_preSelectedQuestPinQid;
  exitQuestPinMode();

  document.getElementById('qpc-coords-display').textContent=
    `Pin at: X=${Math.round(latlng.lng)}, Z=${Math.round(latlng.lat)} on ${MAPS.find(m=>m.id===state.activeMap)?.name||state.activeMap}`;
  document.getElementById('qpc-search').value=_qpcSelectedQid?(questData.find(q=>q.id===_qpcSelectedQid)?.name||''):'';
  document.getElementById('qpc-notes').value=_qpcSelectedQid?(questPins[_qpcSelectedQid]?.notes||''):'';
  // only show remove if this quest already had a pin
  document.getElementById('qpc-remove-btn').style.display=(_qpcSelectedQid&&questPins[_qpcSelectedQid])?'':'none';
  renderQpcList();
  document.getElementById('qpin-confirm').classList.add('open');
}

function removeQuestPinById(){
  if(!_qpcSelectedQid)return;
  delete questPins[_qpcSelectedQid];
  saveQuestState();
  cancelQuestPin();
  renderQuestTracker();
  renderQuestMapMarkers();
  toast('Quest pin removed');
}
  exitQuestPinMode();

  // populate coords display
  document.getElementById('qpc-coords-display').textContent=
    `Pin at: X=${Math.round(latlng.lng)}, Z=${Math.round(latlng.lat)} on ${MAPS.find(m=>m.id===state.activeMap)?.name||state.activeMap}`;

  // prepopulate search if we have a pre-selected quest
  document.getElementById('qpc-search').value=_qpcSelectedQid?(questData.find(q=>q.id===_qpcSelectedQid)?.name||''):'';
  document.getElementById('qpc-notes').value=_qpcSelectedQid?(questPins[_qpcSelectedQid]?.notes||''):'';
  renderQpcList();

  document.getElementById('qpin-confirm').classList.add('open');
}

function renderQpcList(){
  const search=(document.getElementById('qpc-search')?.value||'').toLowerCase();
  const filtered=search
    ?questData.filter(q=>q.name.toLowerCase().includes(search)||q.trader.name.toLowerCase().includes(search))
    :questData.slice(0,40);
  document.getElementById('qpc-list').innerHTML=filtered.map(q=>{
    const pin=questPins[q.id];
    const st=getQuestStatus(q.id);
    return`<div class="qpc-item ${_qpcSelectedQid===q.id?'selected':''}" onclick="selectQpcQuest('${q.id}')">
      <div class="qpc-item-name">${escHtml(q.name)}${st==='active'?' <span style="color:#4a9e6b;font-size:0.5rem;">ACTIVE</span>':''}</div>
      <div class="qpc-item-meta">${q.trader.name} ¬∑ LVL ${q.minPlayerLevel}${pin?' ¬∑ already pinned on '+( MAPS.find(m=>m.id===pin.mapId)?.name||'?'):''}</div>
    </div>`;
  }).join('');
}
function selectQpcQuest(qid){
  _qpcSelectedQid=qid;
  // pre-fill notes from existing pin
  const pin=questPins[qid];
  if(pin)document.getElementById('qpc-notes').value=pin.notes||'';
  renderQpcList();
}
function cancelQuestPin(){
  _pendingQuestPinLatLng=null;_qpcSelectedQid=null;
  document.getElementById('qpin-confirm').classList.remove('open');
  document.getElementById('qpc-remove-btn').style.display='none';
}
function confirmQuestPin(){
  if(!_qpcSelectedQid){toast('Select a quest first',true);return;}
  const existingPin=questPins[_qpcSelectedQid];
  if(!_pendingQuestPinLatLng&&!existingPin){toast('No position ‚Äî click map first',true);return;}
  const latlng=_pendingQuestPinLatLng||{lat:existingPin.z,lng:existingPin.x};
  // If editing an existing pin without moving it, preserve its mapId; otherwise use active map
  const mapId=_pendingQuestPinLatLng?state.activeMap:(existingPin?.mapId||state.activeMap);
  questPins[_qpcSelectedQid]={
    mapId,
    x:Math.round(latlng.lng*10)/10,
    z:Math.round(latlng.lat*10)/10,
    notes:document.getElementById('qpc-notes').value.trim()
  };
  saveQuestState();
  cancelQuestPin();
  renderQuestTracker();
  renderQuestMapMarkers();
  if(mapId===state.activeMap)leafletMap.flyTo([latlng.lat,latlng.lng],1,{duration:.6});
  toast('Quest pin saved');
}

// ‚îÄ‚îÄ STORAGE / UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fitMap(){if(imageOverlay)leafletMap.fitBounds(imageOverlay.getBounds(),{padding:[10,10]});}
function storageKey(id){return`ic_markers_${id}`;}
function loadMarkers(id){try{return JSON.parse(localStorage.getItem(storageKey(id)))||[];}catch(e){return[];}}
function saveMarkersStore(id,m){localStorage.setItem(storageKey(id),JSON.stringify(m));}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded',()=>{
  loadQuestState();
  document.getElementById('map-list').innerHTML=MAPS.map(m=>
    `<button class="map-btn" data-mapid="${m.id}" onclick="selectMap('${m.id}');closeMobileSidebar();"><div class="map-icon">${m.short}</div>${m.name}</button>`
  ).join('');

  leafletMap=L.map('map',{crs:L.CRS.Simple,minZoom:-3,maxZoom:7,zoomSnap:0.25,zoomDelta:0.5,preferCanvas:true,attributionControl:false,touchZoom:true,bounceAtZoomLimits:false});
  markersLayer=L.layerGroup().addTo(leafletMap);
  questMarkersLayer=L.layerGroup().addTo(leafletMap);

  leafletMap.on('mousemove',e=>{
    if(e.originalEvent&&e.originalEvent.pointerType!=='touch')
      document.getElementById('coords-display').textContent=`${Math.round(e.latlng.lng)}, ${Math.round(e.latlng.lat)}`;
  });

  leafletMap.on('click',e=>{
    if(state.questPinMode){handleQuestPinClick(e.latlng);return;}
  });

  leafletMap.on('contextmenu',e=>{
    if(!state.editMode||isMobile())return;
    e.originalEvent.preventDefault();
    state.pendingLatLng=e.latlng;openModal();
  });

  // ESC cancels quest pin mode
  document.addEventListener('keydown',e=>{
    if(e.key==='Escape'){
      if(state.questPinMode)exitQuestPinMode();
      if(document.getElementById('qpin-confirm').classList.contains('open'))cancelQuestPin();
    }
  });

  initLongPress();
  document.getElementById('modal-overlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeModal();});
  document.getElementById('qpin-confirm').addEventListener('click',e=>{if(e.target===e.currentTarget)cancelQuestPin();});

  fetchApiStatus();
  buildLayerToggles();
  fetchQuestData();

  const urlView=new URLSearchParams(window.location.search).get('view');
  if(urlView==='market')switchView('market');
  else if(urlView==='quests')switchView('quests');
  else{switchView('map');selectMap('customs');}
});

// ‚îÄ‚îÄ LONG PRESS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initLongPress(){const el=leafletMap.getContainer();el.addEventListener('pointerdown',onLP_Down,{passive:true});el.addEventListener('pointerup',onLP_Up,{passive:true});el.addEventListener('pointercancel',onLP_Cancel,{passive:true});el.addEventListener('pointermove',onLP_Move,{passive:true});}
function onLP_Down(e){
  // In quest-pin mode, a single tap/click fires the leaflet 'click' event which we already handle
  if(state.questPinMode)return;
  if(!state.editMode)return;
  if(lpActivePointerId!==null){onLP_Cancel();return;}
  if(e.pointerType==='mouse')return;
  lpActivePointerId=e.pointerId;lpStartPos={x:e.clientX,y:e.clientY};
  lpTimer=setTimeout(()=>{lpTimer=null;if(!state.activeMap)return;try{const rect=leafletMap.getContainer().getBoundingClientRect();const cp=L.point(lpStartPos.x-rect.left,lpStartPos.y-rect.top);state.pendingLatLng=leafletMap.containerPointToLatLng(cp);showRipple(lpStartPos.x,lpStartPos.y);openModal();}catch(e){}},550);
}
function onLP_Up(e){if(e.pointerId!==lpActivePointerId)return;onLP_Cancel();}
function onLP_Cancel(){if(lpTimer){clearTimeout(lpTimer);lpTimer=null;}lpActivePointerId=null;lpStartPos=null;}
function onLP_Move(e){if(e.pointerId!==lpActivePointerId||!lpTimer||!lpStartPos)return;const dx=e.clientX-lpStartPos.x,dy=e.clientY-lpStartPos.y;if(dx*dx+dy*dy>100)onLP_Cancel();}
function showRipple(cx,cy){const rect=document.getElementById('map').getBoundingClientRect();const el=document.createElement('div');el.className='lp-ripple';el.style.left=(cx-rect.left)+'px';el.style.top=(cy-rect.top)+'px';document.getElementById('map').appendChild(el);setTimeout(()=>el.remove(),700);}

// ‚îÄ‚îÄ MAP SELECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let activeFloor=0;
function selectMap(id){
  state.activeMap=id;activeFloor=0;
  document.querySelectorAll('.map-btn').forEach(b=>b.classList.toggle('active',b.dataset.mapid===id));
  document.getElementById('map-placeholder').classList.add('hidden');
  if(imageOverlay){imageOverlay.remove();imageOverlay=null;}
  const sw=document.getElementById('floor-switcher');if(sw)sw.remove();
  const mapData=MAPS.find(m=>m.id===id);if(!mapData)return;
  const{bounds}=mapData;
  const lb=[[bounds.minZ,bounds.minX],[bounds.maxZ,bounds.maxX]];
  showMapLoading(true);
  imageOverlay=L.imageOverlay(mapData.img,lb,{opacity:1,interactive:false}).addTo(leafletMap);
  imageOverlay.on('load',()=>showMapLoading(false));
  imageOverlay.on('error',()=>{showMapLoading(false);});
  leafletMap.fitBounds(lb,{padding:[10,10]});
  leafletMap.setMaxBounds([[bounds.minZ-300,bounds.minX-300],[bounds.maxZ+300,bounds.maxX+300]]);
  buildFloorSwitcher(mapData.floors,mapData.id);
  setTimeout(()=>leafletMap.invalidateSize(),300);
  renderMarkers();renderQuestMapMarkers();
}
function buildFloorSwitcher(floors,mapId){const old=document.getElementById('floor-switcher');if(old)old.remove();if(!floors||floors.length<2)return;const sw=document.createElement('div');sw.id='floor-switcher';sw.style.cssText=`position:absolute;bottom:3rem;left:50%;transform:translateX(-50%);z-index:600;display:flex;gap:0.25rem;background:rgba(13,15,13,.9);border:1px solid var(--border2);border-radius:0.25rem;padding:0.25rem;pointer-events:all;`;floors.forEach((label,i)=>{const btn=document.createElement('button');btn.textContent=label;btn.className='tool-btn'+(i===0?' active':'');btn.style.cssText='min-width:3.75rem;font-size:0.55rem;padding:0.25rem 0.5rem;';btn.onclick=()=>switchFloor(i,mapId,floors,sw);sw.appendChild(btn);});document.getElementById('map-view-container').appendChild(sw);}
function switchFloor(index,mapId,floors,sw){activeFloor=index;sw.querySelectorAll('button').forEach((b,i)=>b.classList.toggle('active',i===index));if(!imageOverlay)return;const mapData=MAPS.find(m=>m.id===mapId);if(!mapData)return;const src=index===0?mapData.img:mapData.img.replace('.png',`-${index}.png`);showMapLoading(true);imageOverlay.setUrl(src);imageOverlay.on('load',()=>showMapLoading(false));}
function showMapLoading(show){let el=document.getElementById('map-loading');if(!el&&show){el=document.createElement('div');el.id='map-loading';el.style.cssText=`position:absolute;inset:0;z-index:500;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0.75rem;background:#0d0f0d;pointer-events:none;`;el.innerHTML=`<div style="width:2rem;height:2rem;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;"></div><div style="font-family:var(--mono);font-size:0.6rem;letter-spacing:0.13rem;color:var(--muted);">LOADING</div>`;if(!document.getElementById('spin-style')){const s=document.createElement('style');s.id='spin-style';s.textContent='@keyframes spin{to{transform:rotate(360deg)}}';document.head.appendChild(s);}document.getElementById('map-view-container').appendChild(el);}else if(el&&!show){el.remove();}}

// ‚îÄ‚îÄ MARKERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMarkers(){
  markersLayer.clearLayers();if(!state.activeMap)return;
  const markers=loadMarkers(state.activeMap);
  markers.filter(m=>categoryVisible[m.cat]).forEach(m=>{
    const cfg=CATEGORY_CONFIG[m.cat]||CATEGORY_CONFIG.loot_misc;
    const icon=L.divIcon({html:`<div class="map-marker-icon" style="--mc:${cfg.color}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">${cfg.svg}</svg></div>`,className:'',iconSize:[32,32],iconAnchor:[16,16]});
    L.marker([m.lat,m.lng],{icon}).addTo(markersLayer).on('click',function(){showMarkerPopup(this,m);});
  });
  const el=document.getElementById('marker-list');
  document.getElementById('marker-count').textContent=markers.length;
  if(!markers.length){el.innerHTML=`<div style="padding:0.6rem 0.85rem;font-family:var(--mono);font-size:0.6rem;color:var(--muted);">NO MARKERS<br><span style="font-size:0.55rem;color:var(--border2);">${isMobile()?'Long-press':'Right-click'} map in ADD mode</span></div>`;return;}
  el.innerHTML=markers.map(m=>{const cfg=CATEGORY_CONFIG[m.cat]||CATEGORY_CONFIG.loot_misc;return`<div class="marker-item" onclick="flyToMarker(${m.lat},${m.lng})"><div style="background:${cfg.color}22;border:1px solid ${cfg.color};border-radius:0.25rem;width:1.25rem;height:1.25rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;"><svg viewBox="0 0 24 24" width="11" height="11" fill="none" stroke="${cfg.color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${cfg.svg}</svg></div><div class="marker-item-name">${escHtml(m.name)}</div><div class="marker-item-cat">${cfg.label.toUpperCase()}</div></div>`;}).join('');
}
function showMarkerPopup(lm,m){const cfg=CATEGORY_CONFIG[m.cat]||CATEGORY_CONFIG.loot_misc;L.popup({maxWidth:300,closeButton:true}).setLatLng([m.lat,m.lng]).setContent(`<div class="popup-inner"><div class="popup-cat" style="color:${cfg.color};display:flex;align-items:center;gap:0.35rem;"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="${cfg.color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${cfg.svg}</svg>${cfg.label}</div><div class="popup-title">${escHtml(m.name)}</div>${m.img?`<img class="popup-img" src="${m.img}" alt=""/>`:''}${m.desc?`<div class="popup-desc">${escHtml(m.desc)}</div>`:''}<div class="popup-coords">${m.lat.toFixed(1)}, ${m.lng.toFixed(1)}</div><div class="popup-actions"><button class="btn-sm" onclick="editMarker('${m.id}')">EDIT</button><button class="btn-sm" style="color:var(--danger);border-color:var(--danger);" onclick="deleteMarker('${m.id}')">DELETE</button></div></div>`).openOn(leafletMap);}
function flyToMarker(lat,lng){switchView('map');closeMobileSidebar();leafletMap.flyTo([lat,lng],1,{duration:.6});}

// ‚îÄ‚îÄ MARKER MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(title='ADD MARKER'){document.getElementById('modal-title-text').textContent=title;document.getElementById('modal-overlay').classList.add('open');state.pendingImgDataUrl=null;document.getElementById('img-preview').style.display='none';document.getElementById('img-drop').textContent='TAP TO UPLOAD IMAGE';document.getElementById('m-name').value='';document.getElementById('m-desc').value='';setTimeout(()=>document.getElementById('m-name').focus(),120);}
function closeModal(){document.getElementById('modal-overlay').classList.remove('open');state.pendingLatLng=null;window._modalSaveOverride=null;}
function saveMarker(){if(window._modalSaveOverride){window._modalSaveOverride();return;}if(!state.pendingLatLng||!state.activeMap)return;const name=document.getElementById('m-name').value.trim();if(!name){toast('Name is required',true);return;}const m={id:`m_${Date.now()}`,name,cat:document.getElementById('m-cat').value,desc:document.getElementById('m-desc').value.trim(),img:state.pendingImgDataUrl||null,lat:state.pendingLatLng.lat,lng:state.pendingLatLng.lng,created:Date.now()};const ms=loadMarkers(state.activeMap);ms.push(m);saveMarkersStore(state.activeMap,ms);closeModal();renderMarkers();toast('Marker saved');}
function deleteMarker(id){if(!state.activeMap)return;saveMarkersStore(state.activeMap,loadMarkers(state.activeMap).filter(m=>m.id!==id));leafletMap.closePopup();renderMarkers();toast('Marker deleted');}
function editMarker(id){const ms=loadMarkers(state.activeMap);const m=ms.find(x=>x.id===id);if(!m)return;leafletMap.closePopup();state.pendingLatLng={lat:m.lat,lng:m.lng};state.pendingImgDataUrl=m.img||null;openModal('EDIT MARKER');document.getElementById('m-name').value=m.name;document.getElementById('m-cat').value=m.cat;document.getElementById('m-desc').value=m.desc||'';if(m.img){const p=document.getElementById('img-preview');p.src=m.img;p.style.display='block';document.getElementById('img-drop').textContent='Image loaded ‚Äî tap to replace';}window._modalSaveOverride=()=>{const name=document.getElementById('m-name').value.trim();if(!name){toast('Name is required',true);return;}saveMarkersStore(state.activeMap,ms.map(x=>x.id===id?{...x,name,cat:document.getElementById('m-cat').value,desc:document.getElementById('m-desc').value.trim(),img:state.pendingImgDataUrl!==undefined?state.pendingImgDataUrl:x.img}:x));window._modalSaveOverride=null;closeModal();renderMarkers();toast('Marker updated');};}
function handleImgSelect(e){const f=e.target.files[0];if(f)readImgFile(f);}
function handleImgDrop(e){e.preventDefault();document.getElementById('img-drop').classList.remove('drag-over');const f=e.dataTransfer.files[0];if(f&&f.type.startsWith('image/'))readImgFile(f);}
function readImgFile(file){const r=new FileReader();r.onload=ev=>{state.pendingImgDataUrl=ev.target.result;const p=document.getElementById('img-preview');p.src=ev.target.result;p.style.display='block';document.getElementById('img-drop').textContent=file.name;};r.readAsDataURL(file);}

// ‚îÄ‚îÄ EDIT MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleEditMode(){
  if(state.questPinMode)exitQuestPinMode();
  state.editMode=!state.editMode;
  const btn=document.getElementById('btn-edit');const hint=document.getElementById('edit-hint');
  btn.classList.toggle('active',state.editMode);hint.classList.toggle('show',state.editMode);
  document.getElementById('map-view-container').classList.toggle('edit-mode-active',state.editMode);
  btn.textContent=state.editMode?'‚úï CANCEL':'‚úõ ADD';
  hint.textContent=isMobile()?'LONG-PRESS MAP TO ADD MARKER':'RIGHT-CLICK MAP TO ADD MARKER';
}

// ‚îÄ‚îÄ LAYER TOGGLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildLayerToggles(){const el=document.getElementById('layer-toggles');let html=`<div class="layer-toggle-allrow"><button onclick="setAllLayers(true)">ALL ON</button><button onclick="setAllLayers(false)">ALL OFF</button></div>`;html+=Object.entries(CATEGORY_CONFIG).map(([id,cfg])=>`<button class="layer-toggle" id="lt-${id}" onclick="toggleLayer('${id}')" title="${cfg.label}"><svg viewBox="0 0 24 24" fill="none" stroke="${cfg.color}" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">${cfg.svg}</svg><span class="layer-toggle-label">${cfg.label}</span></button>`).join('');el.innerHTML=html;}
function toggleLayer(cat){categoryVisible[cat]=!categoryVisible[cat];const btn=document.getElementById(`lt-${cat}`);if(btn)btn.classList.toggle('off',!categoryVisible[cat]);renderMarkers();renderQuestMapMarkers();}
function setAllLayers(on){Object.keys(categoryVisible).forEach(k=>{categoryVisible[k]=on;const btn=document.getElementById(`lt-${k}`);if(btn)btn.classList.toggle('off',!on);});renderMarkers();renderQuestMapMarkers();}

// ‚îÄ‚îÄ LOCATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseCoords(raw){const nums=raw.match(/-?\d+\.?\d*/g);if(!nums||nums.length<2)return null;const x=parseFloat(nums[0]);const y=nums.length>=3?parseFloat(nums[1]):null;const z=nums.length>=3?parseFloat(nums[2]):parseFloat(nums[1]);if(isNaN(x)||isNaN(z))return null;return{x,y,z};}
function onCoordInput(input){const p=parseCoords(input.value);const el=document.getElementById('coord-parse-preview');if(!el)return;el.textContent=p?`X:${p.x.toFixed(1)} Y:${p.y!=null?p.y.toFixed(1):'‚Äî'} Z:${p.z.toFixed(1)}`:(input.value.length>2?'Cannot parse':'');}
function locatePlayer(){const raw=document.getElementById('loc-paste').value;const p=parseCoords(raw);if(!p){toast('Paste coordinates',true);return;}clearPlayerMarker();const icon=L.divIcon({html:`<div style="position:relative;width:1.25rem;height:1.25rem;"><div class="player-location-ring"></div><div style="width:0.625rem;height:0.625rem;background:var(--accent);border-radius:50%;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:2px solid #000;box-shadow:0 0 6px var(--accent);"></div></div>`,className:'',iconSize:[20,20],iconAnchor:[10,10]});state.playerMarker=L.marker([p.z,p.x],{icon,zIndexOffset:1000}).addTo(leafletMap).bindPopup(`<div class="popup-inner"><div class="popup-cat" style="color:var(--accent)">YOUR POSITION</div><div class="popup-title">In-Game Location</div><div class="popup-coords">X:${p.x.toFixed(1)} Y:${p.y!=null?p.y.toFixed(1):'‚Äî'} Z:${p.z.toFixed(1)}</div></div>`).openPopup();leafletMap.flyTo([p.z,p.x],leafletMap.getZoom(),{duration:.8});document.getElementById('btn-clear-player').style.display='';toast('Position plotted');}
function clearPlayerMarker(){if(state.playerMarker){state.playerMarker.remove();state.playerMarker=null;}document.getElementById('btn-clear-player').style.display='none';}

// ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchView(view){state.activeView=view;document.querySelectorAll('.nav-tab,.bot-tab').forEach(t=>t.classList.toggle('active',t.dataset.view===view));const mv=document.getElementById('map-view-container');const ca=document.getElementById('content-area');if(view==='map'){mv.style.display='';ca.classList.remove('active');setTimeout(()=>leafletMap?.invalidateSize(),50);}else{mv.style.display='none';ca.classList.add('active');loadContentView(view);}}
function loadContentView(view){const area=document.getElementById('content-area');area.innerHTML=`<div style="padding:2.5rem;font-family:var(--mono);font-size:0.65rem;color:var(--muted);letter-spacing:0.13rem;">LOADING...</div>`;if(view==='market')loadMarketView(area);if(view==='quests')loadQuestsPageView(area);}
function toggleSidebar(){state.sidebarOpen=!state.sidebarOpen;document.getElementById('sidebar').classList.toggle('collapsed',!state.sidebarOpen);document.getElementById('sidebar-toggle').textContent=state.sidebarOpen?'‚Ä∫':'‚Äπ';setTimeout(()=>leafletMap?.invalidateSize(),250);}
function toggleMobileSidebar(){const s=document.getElementById('sidebar');s.classList.contains('mobile-open')?closeMobileSidebar():openMobileSidebar();}
function openMobileSidebar(){document.getElementById('sidebar').classList.add('mobile-open');document.getElementById('sidebar-overlay').classList.add('open');}
function closeMobileSidebar(){document.getElementById('sidebar').classList.remove('mobile-open');document.getElementById('sidebar-overlay').classList.remove('open');setTimeout(()=>leafletMap?.invalidateSize(),300);}
function toggleSection(h){const b=h.nextElementSibling;if(b)b.style.display=b.style.display==='none'?'':'none';}

// ‚îÄ‚îÄ MARKET VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadMarketView(area){
  try{
    const d=await tarkovQuery(`{items(lang:en,limit:200){name shortName avg24hPrice lastLowPrice changeLast48h category{name}iconLink}}`);
    const items=d.items.filter(i=>i.avg24hPrice>0).sort((a,b)=>b.avg24hPrice-a.avg24hPrice);
    area.innerHTML=`<div class="mkt-wrap"><div class="mkt-header">
      <span class="mkt-header-label">FLEA MARKET</span>
      <input class="mkt-search" placeholder="Search items..." oninput="filterMarket(this.value)" />
    </div><div class="mkt-scroll"><table class="mkt-table">
      <thead><tr>
        <th style="width:2.2rem"></th>
        <th>Item</th>
        <th class="mkt-col-cat">Category</th>
        <th>24h Avg</th>
        <th class="mkt-col-low">Low</th>
        <th class="mkt-col-change">Œî48h</th>
      </tr></thead><tbody>
        ${items.map(i=>{const ch=i.changeLast48h||0;const cc=ch>0?'#4a7c59':ch<0?'#8b3a3a':'var(--muted)';return`<tr class="mkt-row"><td><img class="mkt-icon" src="${i.iconLink||''}" onerror="this.style.display='none'"/></td><td><span class="mkt-name-primary">${escHtml(i.shortName)}</span><span class="mkt-name-secondary">${escHtml(i.name)}</span></td><td class="mkt-col-cat"><span class="mkt-cat">${escHtml(i.category?.name||'‚Äî')}</span></td><td><span class="mkt-price">${fmt(i.avg24hPrice)}‚ÇΩ</span></td><td class="mkt-col-low"><span class="mkt-price-low">${fmt(i.lastLowPrice)}‚ÇΩ</span></td><td class="mkt-col-change"><span class="mkt-change" style="color:${cc}">${ch>0?'‚ñ≤':ch<0?'‚ñº':'¬∑'} ${Math.abs(ch).toFixed(1)}%</span></td></tr>`;}).join('')}
      </tbody></table></div></div>`;
  }catch(e){area.innerHTML=apiError('market');}
}
window.filterMarket=q=>{const ql=q.toLowerCase();document.querySelectorAll('.mkt-row').forEach(r=>r.style.display=r.textContent.toLowerCase().includes(ql)?'':'none');};

// ‚îÄ‚îÄ QUESTS PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadQuestsPageView(area){
  if(!questData.length){area.innerHTML=`<div style="padding:2.5rem;font-family:var(--mono);font-size:0.65rem;color:var(--muted);">LOADING QUESTS...</div>`;await fetchQuestData();}
  const traders=[...new Set(questData.map(t=>t.trader.name))].sort();
  area.innerHTML=`<div class="quests-wrap"><div class="quests-header">
    <span style="font-family:var(--mono);font-size:0.65rem;letter-spacing:0.13rem;color:var(--muted);flex-shrink:0;">QUESTS</span>
    <input id="qp-search" style="flex:1;min-width:5rem;padding:0.45rem 0.6rem;background:var(--panel);border:1px solid var(--border2);color:var(--text);font-family:var(--mono);font-size:0.7rem;border-radius:var(--radius);min-height:2.2rem;" placeholder="Search..." oninput="filterQuestsPage()" />
    <select id="qp-trader" style="padding:0.45rem 0.6rem;background:var(--panel);border:1px solid var(--border2);color:var(--text);font-family:var(--mono);font-size:0.65rem;border-radius:var(--radius);min-height:2.2rem;appearance:none;" onchange="filterQuestsPage()">
      <option value="">ALL TRADERS</option>${traders.map(t=>`<option value="${t}">${t}</option>`).join('')}
    </select>
    <select id="qp-status" style="padding:0.45rem 0.6rem;background:var(--panel);border:1px solid var(--border2);color:var(--text);font-family:var(--mono);font-size:0.65rem;border-radius:var(--radius);min-height:2.2rem;appearance:none;" onchange="filterQuestsPage()">
      <option value="">ALL STATUSES</option>
      <option value="active">ACTIVE</option>
      <option value="complete">COMPLETED</option>
      <option value="none">NOT STARTED</option>
    </select>
  </div>
  <div class="quests-grid" id="qp-grid">${questData.map(q=>renderQuestCard(q)).join('')}</div></div>`;
}
function renderQuestCard(q){
  const st=getQuestStatus(q.id);const pin=questPins[q.id];
  return`<div class="quest-card status-${st}" data-trader="${q.trader.name}" data-status="${st}" data-qid="${q.id}">
    ${st!=='none'?`<span class="quest-status-badge ${st}">${st.toUpperCase()}</span>`:''}
    <div class="quest-card-header"><div class="quest-card-name">${escHtml(q.name)}</div><div class="quest-card-lvl">LVL ${q.minPlayerLevel}</div></div>
    <div class="quest-card-trader">${q.trader.name}</div>
    <div class="quest-card-objectives">
      ${q.objectives.slice(0,2).map(o=>`<div>¬∑ ${escHtml(o.description)}</div>`).join('')}
      ${q.objectives.length>2?`<div style="color:var(--border2);font-size:0.65rem;">+${q.objectives.length-2} more</div>`:''}
    </div>
    <div class="quest-card-exp">+${fmt(q.experience)} EXP</div>
    <div class="quest-card-actions">
      <button class="btn-sm" onclick="setQuestStatus('${q.id}','${st==='active'?'none':'active'}');refreshQuestCard('${q.id}')">${st==='active'?'DEACTIVATE':'SET ACTIVE'}</button>
      <button class="btn-sm" style="${st==='complete'?'color:var(--complete-col);border-color:var(--complete-col)':''}" onclick="setQuestStatus('${q.id}','${st==='complete'?'none':'complete'}');refreshQuestCard('${q.id}')">${st==='complete'?'UNMARK':'COMPLETE'}</button>
      <button class="btn-sm ${pin?'':''}${pin?'has-pin':''}" onclick="openQuestPinModal('${q.id}')" style="${pin?'color:var(--accent)':''}">üìç ${pin?MAPS.find(m=>m.id===pin.mapId)?.short||'PIN':'PIN'}</button>
      ${pin?`<button class="btn-sm" onclick="goToQuestPin('${q.id}');switchView('map')">GO TO</button>`:''}
    </div>
  </div>`;
}
function refreshQuestCard(qid){const card=document.querySelector(`.quest-card[data-qid="${qid}"]`);if(!card)return;const q=questData.find(x=>x.id===qid);if(!q)return;const d=document.createElement('div');d.innerHTML=renderQuestCard(q);card.replaceWith(d.firstElementChild);}
window.filterQuestsPage=()=>{const s=(document.getElementById('qp-search')?.value||'').toLowerCase();const tr=document.getElementById('qp-trader')?.value||'';const st=document.getElementById('qp-status')?.value||'';document.querySelectorAll('.quest-card').forEach(c=>{c.style.display=((!s||c.textContent.toLowerCase().includes(s))&&(!tr||c.dataset.trader===tr)&&(!st||c.dataset.status===st))?'':'none';});};

// ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchQuestData(){
  try{const d=await tarkovQuery(`{tasks(lang:en){id name trader{name}minPlayerLevel experience objectives{description}}}`);questData=d.tasks;populateQuestTraderFilter();renderQuestTracker();updateActiveQuestCount();}
  catch(e){const l=document.getElementById('qt-list');if(l)l.innerHTML=`<div style="font-family:var(--mono);font-size:0.55rem;color:var(--danger);padding:0.5rem 0.25rem;">Failed to load quests</div>`;}
}
async function tarkovQuery(query){const r=await fetch(TARKOV_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query})});const j=await r.json();if(j.errors)throw new Error(j.errors[0].message);return j.data;}
async function fetchApiStatus(){try{await tarkovQuery(`{__typename}`);document.getElementById('nav-wipe').textContent='WIPE ACTIVE';}catch(e){document.querySelector('.status-dot').style.background='var(--danger)';document.getElementById('nav-wipe').textContent='API ERR';}}
function apiError(l){return`<div style="padding:2.5rem;font-family:var(--mono);font-size:0.65rem;color:var(--danger);letter-spacing:0.13rem;">FAILED TO LOAD ${l.toUpperCase()}</div>`;}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let toastTimer;
function toast(msg,isError=false){const el=document.getElementById('toast');el.textContent=msg;el.className='show'+(isError?' error':'');clearTimeout(toastTimer);toastTimer=setTimeout(()=>el.className='',2500);}
function fmt(n){return n?n.toLocaleString('en-US'):'‚Äî';}
function escHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
</script>
</body>
</html>
